name: release-wheels

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  verify-tag-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Verify tag matches pyproject version
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_REF_TYPE: ${{ github.ref_type }}
        run: |
          python - <<'PY'
          import os
          import tomllib
          from pathlib import Path

          ref_type = os.environ.get("GITHUB_REF_TYPE", "")
          if ref_type != "tag":
              print("Not running from a tag ref; skipping version/tag verification.")
              raise SystemExit(0)

          tag_name = os.environ["GITHUB_REF_NAME"]
          pyproject = tomllib.loads(Path("pyproject.toml").read_text(encoding="utf-8"))
          version = pyproject["project"]["version"]
          expected_tag = f"v{version}"
          if tag_name != expected_tag:
              raise SystemExit(
                  f"Tag mismatch: got {tag_name!r}, expected {expected_tag!r}"
              )
          print(f"Tag/version match: {tag_name}")
          PY

  build-wheels:
    runs-on: ${{ matrix.os }}
    needs: verify-tag-version
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install build tooling
        run: python -m pip install --upgrade pip build
      - name: Build wheel
        run: python tools/build_wheels.py --out-dir wheelhouse --clean
      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheelhouse-${{ matrix.os }}-py${{ matrix.python-version }}
          path: wheelhouse/*.whl
          if-no-files-found: error

  build-sdist:
    runs-on: ubuntu-latest
    needs: verify-tag-version
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install build tooling
        run: python -m pip install --upgrade pip build
      - name: Build sdist
        run: python -m build --sdist --outdir wheelhouse
      - name: Upload sdist artifact
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: wheelhouse/*.tar.gz
          if-no-files-found: error

  publish-release-assets:
    runs-on: ubuntu-latest
    needs: [build-wheels, build-sdist]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download wheel artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
          pattern: wheelhouse-*
          merge-multiple: true
      - name: Download sdist artifact
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: release-artifacts
      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            release-artifacts/*.whl
            release-artifacts/*.tar.gz
          fail_on_unmatched_files: true
          generate_release_notes: true
